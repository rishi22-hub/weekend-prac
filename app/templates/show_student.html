{% extends "home.html" %}
{% load custom_filters %}



{% block extra_css %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css" />

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

<style>


.select2-search-choice .select2-selection__choice{
  width:100%
}

.select2-container-multi .select2-choices .select2-selection__choice{
    overflow: inherit;
}

.select2-container-multi .select2-choices .select2-search-choice .select2-selection__choice {
     top: 30px;
     width: 270px;
}

</style>
{% endblock %}

{% block main_content %}
    Showing student table:->
    <br>
    filters:->  
<br>
<div id="filter">

    <form id="columnForm" action="{% url 'students' %}" method="post">
        {% csrf_token %}
    <select id="col" name="selected_column">
        <!-- <option value="">All Columns</option> -->
        {% for col in cols %}
        <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
    </select>

    <button type="submit">Add selected columns</button>
    </form>
    <select id="nameFilter" multiple>
        <option value="">All Names</option>
        {% for name in names %}
        <option value="{{ name }}">{{ name }}</option>
        {% endfor %}
    </select>
    
    <select id="collegeFilter" multiple>
        <option value="">All Colleges</option>
        {% for college in colleges %}
        <option value="{{ college }}">{{ college }}</option>
        {% endfor %}
    </select>
    
    <select id="branchFilter" multiple>
        <option value="">All Branches</option>
        {% for branch in branches %}
        <option value="{{ branch }}">{{ branch }}</option>
        {% endfor %}
    </select>
    <!-- <div id="selectedCollege" class="selected-filter" style="display:none;">
        <span class="filter-text"></span>
        <button class="remove-filter">X</button>
    </div>

    <div id="selectedName" class="selected-filter" style="display:none;">
        <span class="filter-text"></span>
        <button class="remove-filter">X</button>
    </div>
    
    <div id="selectedBranch" class="selected-filter" style="display:none;">
        <span class="filter-text"></span>
        <button class="remove-filter">X</button>
    </div> -->
</div>
<div id="selectedValuesContainer"></div>
  <table id="mytable">
    <thead>
    <tr>
        {% for x in fix_col %}
        <td>
            {{x}}
        </td>
        {% endfor %}
    </tr>
</thead>
<tbody>
    {% for x in data %}
   
    <tr>
        {% for y in fix_col %}
        <td> {{x|get_item:y}}</td>
        <!-- <td>{{x.jeerank}}</td>
        <td> {{x.college}}</td>
        <td>{{x.branch}}</td> -->
        {% endfor %}
    </tr>
  
    {% endfor %}
    </tbody>


  </table>

{% endblock %}
{% block extra_js %}
  
  <script>


$(document).ready(function() {
    var table = $('#mytable').DataTable();

    $('#nameFilter, #collegeFilter, #branchFilter,#col').select2({
        placeholder: "Select an option",
    });

    $('#nameFilter, #collegeFilter, #branchFilter').on('change', function() {
        var selectedData = $(this).select2('data'); // Get selected data
        
        var displayHtml = '';
        selectedData.forEach(function(item) {
            displayHtml += '<span class="selected-value">' + item.text + '</span>';
        });
        $('#selectedValuesContainer').html(displayHtml);
    });
    $('#nameFilter, #collegeFilter, #branchFilter').on('change', function() {
        var columnIdx;
        var selectedValues = $(this).val();

        if ($(this).attr('id') === 'nameFilter') {
            columnIdx = 0;
        } else if ($(this).attr('id') === 'collegeFilter') {
            columnIdx = 2;
        } else if ($(this).attr('id') === 'branchFilter') {
            columnIdx = 3;
        }

        if (selectedValues) {
            var regexPattern = selectedValues.join('|');
            table.column(columnIdx).search(regexPattern, true, false).draw();
        } else {
            table.column(columnIdx).search('').draw();
        }
    });

    // Display selected options outside the box
    $('#nameFilter, #collegeFilter, #branchFilter').on("select2:select select2:unselect", function(e) {
        var selectedOptions = $(this).select2("data");
        var displayDiv = $("#displayDiv");
        displayDiv.empty();
        $.each(selectedOptions, function(index, option) {
            displayDiv.append('<div class="selected-option">' + option.text + '</div>');
        });
    });

    // Fetch branches based on the selected college
    $('#collegeFilter').change(function() {
        var selectedCollege = $(this).val();

        if (selectedCollege) {
            $.ajax({
                url: '/get-branches/',
                data: {
                    'college_id': selectedCollege
                },
                success: function(data) {
                    $('#branchFilter').empty().append('<option value="">Select a branch</option>');
                    $.each(data.branches, function(index, branch) {
                        $('#branchFilter').append('<option value="' + branch.id + '">' + branch.name + '</option>');
                    });
                    $('#branchFilter').prop('disabled', false); // Enable the branch Filter
                    $('#branchFilter').trigger('change'); // Notify Select2 to update
                }
            });
        } else {
            $('#branchFilter').empty().append('<option value="">Select a branch</option>').prop('disabled', true);
            $('#branchFilter').trigger('change'); // Notify Select2 to update
        }
    });

});

$(document).ready(function() {

function resetFilter(FilterId, selectedId, columnIndex) {
    $(FilterId).val('');  // Reset the Filter value
    $(selectedId).hide();   // Hide the selected filter display

    
    var table = $('#mytable').DataTable();
    table.column(columnIndex)
        .search('')
        .draw();
}

});
</script>


{% endblock %}
